<!DOCTYPE html>
<html>
<head>
    <!--
       Most of the functions below are written by Jason Carpenter.
       GitHub: https://github.com/jmcarpenter2
   -->
   <title>Psychology Experiment</title>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
   <script src="jspsych-6.0.5/jspsych.js"></script>
   <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
   <!--Your jsPsych plugins below this line-->

   <script src="jspsych-RDK-BM.js"></script>
   <script src="jspsych-instructions.js"></script>
   <script src="jspsych-6.0.5/plugins/jspsych-fullscreen.js"></script>
   <script src="preStimDur_inSecs.js"></script>

   <!--Your jsPsych plugins above this line-->
   <script src="jspsych-6.0.5/plugins/jspsych-external-html.js"></script>
   <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
   <script src="jspsych-6.0.5/plugins/jspsych-html-button-response.js"></script>
</head>
<body>
</body>
<script>

        //Data switches
        var saveLocally = 0;	// 0: Nothing.      1: Download CSV file
        var displayData = 0;  	// 0: Nothing.      1: Display data on browser
        var launchOnline = 0;	// 0: Nothing.		1: Save to database, consent form, completion code generation, dummy variables created for all 3 IDs
        var tableName = 'BrianM_Project'; //Name of the table in the database


        //Get the info from mTurk
        var turkInfo = jsPsych.turk.turkInfo();

        //If we're not on mTurk, we create our own values
        if(turkInfo.outsideTurk === true){

            // Use the timestamp as a unique id (specific to the second)
            var timestamp = Math.floor(Date.now()/1000);

            workerId = "workerId_" + timestamp;
            assignmentId = "assignmentId_" + timestamp;
            hitId = "hitId_" + timestamp;

        }
        //Else we're on mTurk and we get the values
        else{

            var workerId = turkInfo.workerId;
            var assignmentId = turkInfo.assignmentId;
            var hitId = turkInfo.hitId;

        }

        //Print out to console to check
        console.log("workerId: " + workerId);
        console.log("assignmentId: " + assignmentId);
        console.log("hitId: " + hitId);


        //------------------- Your code below this line -------------------

        var apertureType = 4;
        var apertureWidth = 800;
        var apertureHeight = 400;
        var feedbackTime = null;//null is indefinitely
        var exampleTrialDuration = 4000;

        var coherentDirectionMotion = 270;//270 is downwards

        //Points Counter
        points_p2 = 0;
        points_p2_LR = 0;
        points_p2_LR_threshold = 7; //>= this to pass
        points_exp = 0;

        //Keep track of blocks completed
        blocks_completed = 0;


        //Change the Seconds to Milliseconds
        var preStimDur_inMS = [];
        preStimDur_inSecs.forEach(dur_inSecs => {preStimDur_inMS.push(dur_inSecs*1000);});



        //--------------------- Make Exp Trials ---------------------
        //Make an array of experiment trial objects
        var exp_block_array = makeExpBlockArray();
        var rest_block_array = makeRestBlockArray();
        console.log(exp_block_array);


        var timeline = []; //Keep this
        timeline.push(fullscreen());
        timeline.push(instructions_eg1());
        timeline.push(example_1());
        timeline.push(instructions_eg2());
        timeline.push(example_2());
        timeline.push(instructions_p1());
        timeline.push(practice_1());
        timeline.push(instructions_p2());
        timeline.push(practice_2());
        timeline.push(instructions_p3());
        timeline.push(practice_3());
        timeline.push(instructions_exp());
        timeline.push(exp_block_array[0]);
        timeline.push(rest_block_array[0]);
        timeline.push(exp_block_array[1]);
        timeline.push(rest_block_array[1]);
        timeline.push(exp_block_array[2]);
        timeline.push(rest_block_array[2]);
        timeline.push(exp_block_array[3]);
        timeline.push(rest_block_array[3]);
        timeline.push(exp_block_array[4]);
        timeline.push(rest_block_array[4]);
        timeline.push(exp_block_array[5]);


        //------------------- Your code above this line -------------------

        if(launchOnline){
        	timeline.unshift(createConsentFormBlock())
           timeline.push(createCompletionCodeBlock());
           timeline.push(createGoodbyeBlock());
       }

        //Initiate the experiment
        jsPsych.init({
            timeline: timeline,
            on_finish: function(){ //Execute this when the experiment finishes
                if(saveLocally == true){
                    jsPsych.data.get().localSave('csv','testSave.csv'); //Save the data locally in a .csv file
                }
                if(displayData == true){
                    jsPsych.data.displayData(); //Display the data onto the browser screen
                }
            },
            on_trial_finish: function(){ //Execute this after every trial
                if (launchOnline == true){
                    save_data(tableName, [jsPsych.data.get().last(1).values()[0]]);
                }
            }
        });


        //==============================
        //========= FUNCTIONS ==========
        //==============================

        //Function to make the experiment trial objects
        function makeExpBlockArray(){

            var tempArray = [];

            nDotsArray = [200, 200, 600, 600, 1000, 1000];

            for(var i = 0; i < 6; i++){
                //Factors to create counterbalanced trials
                var factors = {
                    coherences: [0.2, 0.4, 0.6, 0.8, 1],
                    //nDots: [200,600,1000],
                    stimulusSide:['left','right'],
                    coherentDirection: [coherentDirectionMotion]
                };
                var repetitions = 5;
                var unpack = 1;

                var trialInput = jsPsych.randomization.factorial(factors, repetitions, unpack);

                console.log(trialInput);

                trialInput.nDots = jsPsych.randomization.repeat(nDotsArray[i], 50);

                tempArray.push({
                    type: 'RDK-BM',
                    n_dots_array: trialInput.nDots,
                    coherence_array: trialInput.coherences,
                    stimulus_side_array: trialInput.stimulusSide,
                    coherent_direction_array: trialInput.coherentDirection,
                    aperture_type: apertureType, //4 is rectangle
                    aperture_height: apertureHeight,
                    aperture_width: apertureWidth,
                    aperture_center_x: function(){
                        return window.innerWidth/2;
                    },
                    aperture_center_y: function(){
                        return window.innerHeight/2;
                    },
                    preStim_dur_in_ms: preStimDur_inMS,
                    data: function(){
                		var trialTypeString = 'exp_block_' + (blocks_completed+1);
                    	return {trialType: trialTypeString};
                    },
                    on_finish: function(){
                        //Add the points from this block to the main points counter
                        var data = jsPsych.data.get().last(1).values()[0];
                        var points_from_block = data.points;
                        points_exp += points_from_block;
                        console.log("points_from_block: " + points_from_block);
                        console.log("points_exp: " + points_exp);
                        blocks_completed++;
                        console.log("blocks_completed: " + blocks_completed)
                    }
                });
            } //End of for loop

            //Return the temp Array
            return jsPsych.randomization.repeat(tempArray,1);

        }//End of makeExperimentTrialsArray

        //Function to make the experiment trial objects
        function makeRestBlockArray(){

            var tempArray = [];

            for(var i = 0; i < 5; i++){

                let trialType = 'rest_block_' + (i+1);

                tempArray.push({
                    type: 'html-keyboard-response',
                    stimulus: function(){

                        if(points_exp >= 0){
                            var points_color = 'green';
                        }
                        else{
                            points_color = 'red';
                        }

                        return '<p>Great job! You\'re ' + blocks_completed + '/6 of the way there!</p><p>Your score is currently <span style="color:' + points_color + '">' + points_exp + '</span>.</p><p>Feel free to take a 1-minute break to rest your eyes.</p>';
                    },
                    choices: [32],
                    prompt: "<p>Once you are ready, press the spacebar to continue to the next third of trials.</p>",
                    data: {trialType: trialType}
                });
            } //End of for loop

            //Return the temp Array
            return tempArray;
        }
        //End of makeExperimentTrialsArray

        function fullscreen(){
            return {
                type: 'fullscreen',
                fullscreen_mode: true,
                message: '<p> Welcome to the experiment!</p><p>This experiment requires that your browser be in fullscreen mode. When you click "Next" below, your browser will be put to fullscreen mode automatically.</p>',
                button_label: 'Next >'
            };
        }


        function instructions_eg1(){
            return {
                type: 'instructions',
                pages: [
                '<p> Thank you for agreeing to participate in our experiment! </p><p>Before we give you the instructions, we would like to reiterate from the consent form that:</p><p>(1) You will be compensated $4 for the completion of the study<br>(2) The study will last a little under one hour<br>(3) We reserve the right to terminate your session at any time<br>(4) If we terminate your session, you will be paid for the total amount of time you participated at a rate of $4/hour, up to one hour total.</p><p> Click "Next" below if you understand and agree to these terms. </p>',
                '<p> It is imperative for you to understand the task in order for this experiment to work. As such, we will be monitoring how well you do the task. If your performance indicates that you do not understand the task or are not paying attention, we will terminate the experiment.</p><p> If we terminate the experiment, you should <b>not</b> submit the assignment. <span style="color:red"><i>We will reject the assignment if you submit the assignment after termination.</i></span> Instead, you will be given more instructions on how to receive compensation from us. We will then compensate you manually through mTurk.</p>',
                '<p> In this experiment, you be shown dots moving on the screen. In the middle of the screen will be a fixation cross. During the entire experiment, you will keep your eyes fixed on the fixation cross.</p>',
                '<p> As you keep your gaze fixed on the fixation cross in the center of the screen, dots will be moving on the screen randomly. At a certain point, some of the dots will very briefly move coherently downwards (like a waterfall). This downward motion will occur either to the left or to the right of the fixation cross.</p> <p>Your job is to judge whether the coherent downward motion occurs to the left or right of the fixation cross.</p>',
                '<p> When you click "Next" below, you will be shown a modified example of a trial.</p><p>After a few seconds of stimulus presentation, two gray circles will show up on the left and right sides of the fixation cross to indicate the two locations where the coherent downward-moving dots could occur. Keep your eyes on the fixation cross but pay attention to the circles, as the coherent downward dots will be presented only very briefly (half a second). </p><p>The example will end by itself and you will be given more instructions.</p>'
                ],
                show_clickable_nav: true,
                data: {trialType: 'instructions_eg1'}

            };
        }

        function example_1(){
            return {
                type: 'RDK-BM',
                trial_duration: exampleTrialDuration,
                n_dots_array: [1000],
                coherence_array: [1],
                stimulus_side_array: ['left'],
                coherent_direction_array: [coherentDirectionMotion],
                aperture_type: apertureType, //4 is rectangle
                aperture_height: apertureHeight,
                aperture_width: apertureWidth,
                aperture_center_x: function(){
                    return window.innerWidth/2;
                },
                aperture_center_y: function(){
                    return window.innerHeight/2;
                },
                preStim_dur_in_ms: preStimDur_inMS,
                data: {trialType: 'example_1'},
                visible_circle: true
            };
        }


        function instructions_eg2(){
            return {
                type: 'instructions',
                pages: [
                '<p> Did you manage to see the coherent downward-moving dots on the left side?</p><p>It is okay if you did not. The time in which it moves downwards is very short (half a second), so be sure to be attentive.</p><p> The next example is similar, except that it will be on the right side of the fixation cross.</p>',
                '<p> After you click "Next" below, keep your eyes on the fixation cross but pay attention to the inside of the gray circle on the right side. You should be able to notice dots moving downwards for a very short time.</p>'
                ],
                show_clickable_nav: true,
                data: {trialType: 'instructions_eg2'}

            };
        }

        function example_2(){
            return {
                type: 'RDK-BM',
                trial_duration: exampleTrialDuration,
                n_dots_array: [1000],
                coherence_array: [1],
                stimulus_side_array: ['right'],
                coherent_direction_array: [coherentDirectionMotion],
                aperture_type: apertureType, //4 is rectangle
                aperture_height: apertureHeight,
                aperture_width: apertureWidth,
                aperture_center_x: function(){
                    return window.innerWidth/2;
                },
                aperture_center_y: function(){
                    return window.innerHeight/2;
                },
                preStim_dur_in_ms: preStimDur_inMS,
                data: {trialType: 'example_1'},
                visible_circle: true
            };
        }

        function instructions_p1(){
            return {
                type: 'instructions',
                pages: [
                '<p> Hopefully you managed to notice that the dots on the right of the fixation cross were moving downwards for a short period of time. </p>',
                '<p> You might have also noticed that the fixation cross changed its color from <span style="color:red"> red </span> to <b>black</b>. This is a cue for you to let us know which side of the fixation cross the coherent downward-moving dots occurred. This coherent downward dot motion occurs some time after the trial begins and ends right before the fixation cross turns black.</p>',
                '<p> If you think the downward coherent dots occurred to the left of the fixation cross, press the "1" key (above the "Q" key). <br>If you think the coherent dots occurred to the right of the fixation cross, press the "2" key (above the "W" key).</p><p>You can place your index finger and middle finger of your left hand on those keys as this will be the only response for your left hand.</p><p> You can only respond once the fixation cross turns <b>black</b>.</p>',
                '<p> Once you have pressed either the "1" or "2" keys, the fixation cross will turn <span style="color:gray">gray</span>.</p><p>When this happens, you will have to key in your confidence judgment. This indicates how confident you are in your judgment on which side of the fixation cross the coherent dots occurred.</p>',
                '<p> The responses for confidence will be the keys "7", "8", "9", and "0". You can place the fingers of your right hand on those keys as that will be the only responses from that hand.</p><p> Here are what the responses mean:</p><p>"7" = Not confident at all &nbsp; <br> "8" = Slightly confident  &nbsp; &nbsp; &nbsp;<br> "9" = Quite confident  &nbsp; &nbsp; &nbsp; &nbsp;<br> "0" = Extremely confident </p><p>Make sure that you are aware that your index finger gives the lowest confidence, and your pinky finger gives the highest confidence.</p><p> Once you have given your confidence response, the fixation cross will turn from gray to white.</p>',
                /*'<p> You have only 3 seconds to key in both responses, so you will have to do it quickly. It is important to key in both responses before the time limit runs out.</p>*/'<p>You can confirm that you have keyed in both responses in time by observing that the fixation cross turns white in every trial before it turns red again to indicate the start of the following trial.</p>',
                '<p> That was a lot of information, thank you for sticking with us. Here is a quick recap of what we covered:</p><p>Your job is to judge which side of the fixation cross the coherent dots occurred.</p><p> When the fixation cross turns <b>black</b>, press "1" or "2" to indicate if the coherent dots occurred on the left or right of the fixation cross respectively. Once you indicate this, the fixation cross will turn <span style="color:gray">gray</span>. Now you can indicate your confidence by pressing "7", "8", "9", or "0" ("7" is least confident and "0" is most confident). Once you have given both responses, the fixation cross will turn white until the start of the following trial.</p>'+/*<p>You have 3 seconds from the time the fixation cross turns <b>black</b> to key in both responses.</p>*/'<p> Feel free to click "Previous" to review earlier instructions.</p>',
                '<p> We understand that this task can be quite challenging, so we have prepared 3 sets of practice trials for you. In the first set, there will be 6 practice trials, and you will be given feedback on your performance at the end of each trial. </p><p>In the first set of practice trials, the gray circle will be present to help guide your attention. It is imperative that you <i>do not look at the gray circle</i> and keep your eyes fixed on the fixation cross. This is because the actual experiment will not have a gray circle to guide you.</p><p>'+/*Remember that once the fixation cross turns <b>black</b>, you have only <b>3 seconds</b> to give both responses before it moves on to the next trial.*/ 'Remember that the fixation cross should turn from black to gray to white before the next trial. We have implemented a point-system to measure your performance, and this will be explained after the first set of practice trials.</p>',
                '<p> When you click "Next" below, the first set of 6 practice trials will begin.</p><p>Remember to keep your eyes on the center of the fixation cross. Use these 6 practice trials to familiarize yourself with the task.</p><p>This task is meant to be difficult, and if you are unsure of where the coherent dots occurred, just take your best guess.</p>'
                ],
                show_clickable_nav: true,
                data: {trialType: 'instructions_p1'}
            };
        }

        function practice_1(){

            //Create the random variables
            let factors_p1 = {
                coherences: [1],
                stimulusSide:['left','right'],
                nDots: [200, 600, 1000]
            };

            let trialInput_p1 = jsPsych.randomization.factorial(factors_p1, 1, 1);

            let coherentDirection_p1 = jsPsych.randomization.repeat([coherentDirectionMotion], 10);

            //For loop that pushes each practice trial and feedback trial into the array
            let p1_array = [];

            for (var i = 0; i < 6; i++){

                //RDK trial
                let RDK_p1= {
                    type: 'RDK-BM',
                    n_dots_array: [trialInput_p1.nDots[i]],
                    coherence_array: [trialInput_p1.coherences[i]],
                    stimulus_side_array: [trialInput_p1.stimulusSide[i]],
                    coherent_direction_array: [coherentDirection_p1[i]],
                    aperture_type: apertureType,
                    aperture_height: apertureHeight,
                    aperture_width: apertureWidth,
                    aperture_center_x: function(){
                        return window.innerWidth/2;
                    },
                    aperture_center_y: function(){
                        return window.innerHeight/2;
                    },
                    preStim_dur_in_ms: preStimDur_inMS,
                    data: {trialType: 'practice_1'},
                    visible_circle: true
                };

                //Feedback trial
                let feedback_p1 = {
                    type: 'html-keyboard-response',
                    stimulus: function(){
                        //Get the data of the last trial
                        let data = jsPsych.data.getLastTrialData();

                        var message = '';

                        //First response
                        let correct = JSON.parse(jsPsych.data.get().last(1).values()[0].correctOrNotArray)[0];

                        console.log("CORRECT: " + correct);

                        if(correct === 1){
                            message += '<h1 style="color:green"> Correct Left/Right response! </h1>';
                        }
                        else if(correct === 0){
                            message += '<h1 style="color:red"> Incorrect Left/Right response! </h1>';
                        }
                        else if(correct === -1){
                            message += '<h1 style="color:red"> No response entered! </h1><p>Remember to respond when the fixation cross turns black.</p>';
                        }

                        message += "<br><br>";

                        //Second response
                        let responded = JSON.parse(jsPsych.data.get().last(1).values()[0].confRespOrNotArray)[0];

                        console.log("RESPONDED: " + responded);

                        if(responded === 1){
                            message += '<h1 style="color:green"> Confidence response successfully recorded! </h1>';
                        }
                        else if(responded === -1){
                            message += '<h1 style="color:red"> No confidence response recorded! </h1><p>Remember to rate confidence when the fixation cross turns gray.</p>';
                        }

                        //Instructions to move on
                        message += '<br><p>Press the spacebar to move on.</p>';

                        return message;
                    },
                    choices: [32],
                    prompt: "",
                    trial_duration: feedbackTime,
                    data: {
                        trialType: 'feedback_1',
                        key_press: 0
                        },
                    on_finish: function(){
                        //jsPsych.data.get().addToLast({rt: 0});
                    }
                };

                //Push the pair into the p1 array
                p1_array.push(RDK_p1);
                p1_array.push(feedback_p1);

            }//End of for loop

            return {
                type: 'html-keyboard-response',
                timeline: p1_array
            };
        }

        function instructions_p2(){
            return {
                type: 'instructions',
                pages: [
                '<p> Well done on the first set of practice trials!<p></p>We hope you managed to familiarize yourself to the task somewhat.</p> ',
                '<p> The next set will have 10 practice trials. These practice trials will be exactly like the previous set, except there will be no gray circles to help you.</p><p>The actual experiment will also not have any gray circles.</p>',
                '<p> In this block, we will also introduce a point system to determine your performance.</p><p>If your first (left/right) response is <span style="color:green">correct</span>, you get <span style="color:green">1 point</span>. If it is <b>wrong</b>, you get <b>0 points</b>. '+/*However, if you <span style="color:red">fail to respond</span>, you get <span style="color:red">-1 points</span>.*/'</p><p>For your second response (confidence judgment), there is no correct answer. Thus, if you <span style="color:green">respond</span>, you get <span style="color:green">1 point</span>.'+/*' If you <span style="color:red">do not respond</span>, you get <span style="color:red">-1 points</span>.</p><p>Thus to maximize your points, it is in your interest to respond to both questions within each trial.*/'</p>',
                /*'<p> These trials also serve as a test. This experiment will only work if you understand the task. As such, you will need to make at least 7 correct left/right judgments to continue to the actual experiment. If you do not succeed in getting this number of left/right judgments correct, the task will end and you will be given more instructions on getting compensation from us.</p>',
                */'<p> Remember to keep your eyes fixed on the fixation cross'+/*, and to key in both responses within the 3 seconds to maximize your points*/'. You should see the fixation cross turn white before the next trial. </p><p>Whenever you are ready, click "Next" below to start the second set of 10 practice trials.</p>'
                ],
                show_clickable_nav: true,
                data: {trialType: 'instructions_p2'}
            };
        }

        function practice_2(){

            //Create the random variables
            let coherences_p2 = jsPsych.randomization.repeat([1], 10);
            let stimulusSide_p2 = jsPsych.randomization.repeat(['left','right'], 5);
            let coherentDirection_p2 = jsPsych.randomization.repeat([coherentDirectionMotion], 10);
            let nDots_p2 = jsPsych.randomization.sampleWithReplacement([200, 600, 1000], 10);


            //For loop that pushes each practice trial and feedback trial into the array
            let p2_array = [];

            for (var i = 0; i < 10; i++){

                //RDK trial
                let RDK_p2= {
                    type: 'RDK-BM',
                    n_dots_array: [nDots_p2[i]],
                    coherence_array: [coherences_p2[i]],
                    stimulus_side_array: [stimulusSide_p2[i]],
                    coherent_direction_array: [coherentDirection_p2[i]],
                    aperture_type: apertureType,
                    aperture_height: apertureHeight,
                    aperture_width: apertureWidth,
                    aperture_center_x: function(){
                        return window.innerWidth/2;
                    },
                    aperture_center_y: function(){
                        return window.innerHeight/2;
                    },
                    preStim_dur_in_ms: preStimDur_inMS,
                    data: {trialType: 'practice_2'},
                    visible_circle: false                };

                //Feedback trial
                let feedback_p2 = {
                    type: 'html-keyboard-response',
                    stimulus: function(){
                        //Get the data of the last trial
                        let data = jsPsych.data.getLastTrialData();

                        var message = '';

                        //First response
                        let correct = JSON.parse(jsPsych.data.get().last(1).values()[0].correctOrNotArray)[0];

                        console.log("CORRECT: " + correct);

                        if(correct === 1){
                            message += '<h1 style="color:green"> Correct Left/Right response! (+1) </h1>';
                            points_p2 += 1;
                            points_p2_LR += 1;
                        }
                        else if(correct === 0){
                            message += '<h1 style="color:red"> Incorrect Left/Right response! (+0) </h1>';
                        }
                        else if(correct === -1){
                            message += '<h1 style="color:red"> No response entered! (-1) </h1><p>Remember to respond when the fixation cross turns black.</p>';
                            points_p2 -= 1;
                        }

                        message += "<br><br>";

                        //Second response
                        let responded = JSON.parse(jsPsych.data.get().last(1).values()[0].confRespOrNotArray)[0];

                        console.log("RESPONDED: " + responded);

                        if(responded === 1){
                            message += '<h1 style="color:green"> Confidence response successfully recorded! (+1) </h1>';
                            points_p2 += 1;
                        }
                        else if(responded === -1){
                            message += '<h1 style="color:red"> No confidence response recorded! (-1) </h1><p>Remember to rate confidence when the fixation cross turns gray.</p>';
                            points_p2 -= 1;
                        }

                        //Report the points
                        message += "<br><br>";
                        message += '<h2> Total Points: <span style="color:';

                        if(points_p2 >= 0){
                            message += 'green';
                        }
                        else{
                            message += 'red';
                        }

                        message += '">' + points_p2 + '</span></h2>';

                        //Instructions to move on
                        message += '<br><p>Press the spacebar to move on.</p>';

                        //Return the message
                        return message;
                    },
                    choices: [32],
                    prompt: "",
                    trial_duration: feedbackTime,
                    data: {
                        trialType: 'feedback_2',
                        key_press: 0
                        },
                    on_finish: function(){
                        //jsPsych.data.get().addToLast({rt: 0});
                    }
                };

                //Push the pair into the p1 array
                p2_array.push(RDK_p2);
                p2_array.push(feedback_p2);

            }//End of for loop

            return {
                type: 'html-keyboard-response',
                timeline: p2_array
            };
        }

        function instructions_p3(){
            return {
                type: 'instructions',
                pages: function(){
                    //If we pass
                    if(points_p2_LR >= points_p2_LR_threshold){
                        return [
                        '<p> Well done!</p></p>You are done with 2/3 of the practice trials! Hopefully you\'re somewhat familiar with the task and point system now.</p> ',
                        '<p>The next set of 6 practice trials will be exactly like the main experiment.</p>'+/*<p>There will be no feedback given, and the trials will move from one trial to another by itself. Note that there will be no pause in between trials.</p><p>In addition, i*/'<p>In most trials, not all of the dots in the circle will move downwards in a coherent manner. The number of dots that move coherently downwards can be anywhere from 100% of dots (easy trials) to 20% (difficult trials). </p>',
                        '<p> As usual, keep your eyes on the fixation cross for the entire duration of the trial. If you are unsure of which side of the fixation cross the coherent downward-moving dots occured, just take your best guess.</p><p>Remember that this task is meant to be difficult, so do not be discouraged if you are guessing much of the time.</p><p>Whenever you are ready, click "Next" below to start the next set of 6 practice trials.</p>'
                        ];
                    }
                    //Else we fail
                    else{
                        return [
                        '<p> Thank you for participating. Unfortunately your score does not allow you to proceed with the experiment. </p><p> Please email <b>ucrNeuralComputation@gmail.com</b> with: <br><br>(1) Your unique ID for this task: <b>' + workerId + ' </b>, and <br>(2) Your own mTurk worker ID <br><br>to receive compensation for your time.</p><p>You have not been provided with the completion code, so please <span style="color:red"><b>do NOT submit the assignment.</span> Do not paste anything in the completion code box on the mTurk website.</b> We will compensate you through a customized Dummy HIT for you only. Please <b>return this assignment</b> so that someone else can do the task. <span style="color:red"><b>If you submit the assignment, we will REJECT the assignment</b></span>.</p><p>Once you have emailed us with the 2 pieces of information listed above, feel free to close this browser window and return the assignment. You do not have to do anything else. We sincerely thank you for your time.</p>'
                        ];
                    }
                },
                show_clickable_nav: function(){
                    if(points_p2_LR >= points_p2_LR_threshold){
                        return true;
                    }
                    else{
                        return false;
                    }
                },
                keyforward: 'q',
                data: {trialType: 'instructions_p3'}
            };
        }

        function practice_3(){

            let coherences_p3 = jsPsych.randomization.sampleWithReplacement([1, 0.8, 0.6, 0.4, 0.2], 6);
            let stimulusSide_p3 = jsPsych.randomization.repeat(['left','right'], 3);
            let nDots_p3 = jsPsych.randomization.repeat([200, 600, 1000], 2);
            let coherentDirection_p3 = jsPsych.randomization.repeat([coherentDirectionMotion], 10);

            return {
                type: 'RDK-BM',
                n_dots_array: nDots_p3,
                coherence_array: coherences_p3,
                stimulus_side_array: stimulusSide_p3,
                coherent_direction_array: coherentDirection_p3,
                aperture_type: apertureType, //4 is rectangle
                aperture_height: apertureHeight,
                aperture_width: apertureWidth,
                aperture_center_x: function(){
                    return window.innerWidth/2;
                },
                aperture_center_y: function(){
                    return window.innerHeight/2;
                },
                preStim_dur_in_ms: preStimDur_inMS,
                data: {trialType: 'practice_3'},
                visible_circle: false
            };
        }

        function instructions_exp(){
            return {
                type: 'instructions',
                pages: [
                '<p> Amazing work! You\'re all done with practice.<p></p>It\'s time to move on to the actual experiment.</p> ',
                '<p> This experiment will last around 45 minutes, and you will have a break every 5 minutes or so.</p><p>You total points will be shown during the breaks.</p>',
                '<p> Remember to keep your eyes fixed on the fixation cross.</p><p>The actual experiment will likely be more difficult than the practice trials that you did earlier. Even so, do not be discouraged and just do your best on every trial.</p><p> Whenever you are ready, click "Next" below to begin the experiment. Good luck!</p>'
                ],
                show_clickable_nav: true,
                data: {trialType: 'instructions_exp'}
            };
        }

        function exp_block_1(){
            return {
                type: 'RDK-BM',
                n_dots_array: nDots_array_1,
                coherence_array: coherence_array_1,
                stimulus_side_array: stimulusSide_array_1,
                coherent_direction_array: coherentDirection_array_1,
                aperture_type: apertureType, //4 is rectangle
                aperture_height: apertureHeight,
                aperture_width: apertureWidth,
                aperture_center_x: function(){
                    return window.innerWidth/2;
                },
                aperture_center_y: function(){
                    return window.innerHeight/2;
                },
                preStim_dur_in_ms: preStimDur_inMS,
                data: {trialType: 'exp_block_1'},
                on_finish: function(){
                    //Add the points from this block to the main points counter
                    var data = jsPsych.data.get().last(1).values()[0];
                    var points_from_block = data.points;
                    points_exp += points_from_block;
                    console.log("points_from_block: " + points_from_block);
                    console.log("points_exp: " + points_exp);
                }
            };
        }

        function rest_block_1(){
            return {
                type: 'html-keyboard-response',
                stimulus: function(){

                    if(points_exp >= 0){
                        var points_color = 'green';
                    }
                    else{
                        points_color = 'red';
                    }

                    return '<p>Great job! You\'re 1/3 of the way there!</p><p>Your score is currently <span style="color:' + points_color + '">' + points_exp + '</span>.</p><p>Feel free to take a 1-minute break to rest your eyes.</p>';
                },
                choices: [32],
                prompt: "<p>Once you are ready, press the spacebar to continue to the next third of trials.</p>",
                data: {trialType: 'rest_block_1'}
            };
        }

        function exp_block_2(){
            return {
                type: 'RDK-BM',
                n_dots_array: nDots_array_2,
                coherence_array: coherence_array_2,
                stimulus_side_array: stimulusSide_array_2,
                coherent_direction_array: coherentDirection_array_2,
                aperture_type: apertureType, //4 is rectangle
                aperture_height: apertureHeight,
                aperture_width: apertureWidth,
                aperture_center_x: function(){
                    return window.innerWidth/2;
                },
                aperture_center_y: function(){
                    return window.innerHeight/2;
                },
                preStim_dur_in_ms: preStimDur_inMS,
                data: {trialType: 'exp_block_2'},
                on_finish: function(){
                    //Add the points from this block to the main points counter
                    var data = jsPsych.data.get().last(1).values()[0];
                    var points_from_block = data.points;
                    points_exp += points_from_block;
                }
            };
        }

        function rest_block_2(){
            return {
                type: 'html-keyboard-response',
                stimulus: function(){

                    if(points_exp >= 0){
                        var points_color = 'green';
                    }
                    else{
                        points_color = 'red';
                    }

                    return '<p>Great job! You\'re 2/3 of the way there!</p><p>Your score is currently <span style="color:' + points_color + '">' + points_exp + '</span>.</p><p>Feel free to take a 1-minute break to rest your eyes.</p>';
                },
                choices: [32],
                prompt: "<p>Once you are ready, press the spacebar to continue to the next third of trials.</p>",
                data: {trialType: 'rest_block_2'}
            };
        }

        function exp_block_3(){
            return {
                type: 'RDK-BM',
                n_dots_array: nDots_array_3,
                coherence_array: coherence_array_3,
                stimulus_side_array: stimulusSide_array_3,
                coherent_direction_array: coherentDirection_array_3,
                aperture_type: apertureType, //4 is rectangle
                aperture_height: apertureHeight,
                aperture_width: apertureWidth,
                aperture_center_x: function(){
                    return window.innerWidth/2;
                },
                aperture_center_y: function(){
                    return window.innerHeight/2;
                },
                preStim_dur_in_ms: preStimDur_inMS,
                data: {trialType: 'exp_block_3'},
                on_finish: function(){
                    //Add the points from this block to the main points counter
                    var data = jsPsych.data.get().last(1).values()[0];
                    var points_from_block = data.points;
                    points_exp += points_from_block;
                }
            };
        }

        function rest_block_3(){
            if(points_exp >= 0){
                var points_color = 'green';
            }
            else{
                points_color = 'red';
            }
            return {
                type: 'html-keyboard-response',
                stimulus: function(){

                    if(points_exp >= 0){
                        var points_color = 'green';
                    }
                    else{
                        points_color = 'red';
                    }

                    return '<p>Great job! You\'re done with the experiment!</p><p>Your final score is <span style="color:' + points_color + '">' + points_exp + '</span>.</p>';
                },
                choices: [32],
                prompt: "<p>Press the spacebar to get your completion code.</p>",
                data: {trialType: 'rest_block_3'}
            };
        }



        //-------- Trial-Making --------

        //Creates a consent form trial and returns it
        function createConsentFormBlock(){

            return {
                type:'external-html',
                url: "consentForm.html",
                cont_btn: "startExperimentButton",
                check_fn: check_consent
            };
        }

        //Create trial to generate completion code, and check if they've earned a bonus on this session
        function createCompletionCodeBlock(){

        return {
                type: 'html-keyboard-response',
                stimulus: '<center><p class="loader" style="margin-top: 20%">Loading...</p></center>',
                timing_response: 1,
                trial_duration: 10,
    	        //display_element: $('#vert-center'),
    	        on_finish: function(data)
    	        {
    	            // Create completionCode and check if it exists in the database. Keep running until a unique one is generated
    	            completionCode = Math.floor(Math.random() * 9000000 + 1000000);
    	            checkID(false, completionCode, 'completion_code', tableName, function(exists){getNewSubID(exists);});

                    //Add in artificial rt to fill in the column in the database
                    jsPsych.data.get().addToLast({rt: 0});
                    jsPsych.data.get().addToLast({key_press: 0});
                    jsPsych.data.get().addToLast({points_exp: points_exp});
                },
                timing_post_trial: 0
            };
        }

        //Create trial to thank the participate, tell them about their bonus, and display their completionCode completion code
        function createGoodbyeBlock(){

            return {
                type: 'html-button-response',
                stimulus: function()
                {
                    var output = '<p class="instructions">You are done with the experiment! Thank you for participating!</p>';
                    var data = jsPsych.data.get().last(1).values()[0];
                    var completionCode = data.completion_code;

	                  // Display completionCode completion code
	                  output += '<p class="instructions"> Your completion code is: <strong>'+ completionCode + '</strong></p>' +
                    '<p class="instructions">Please paste this number back into the box at the mTurk HIT website. Once you are done, please click the button below to officially end the experiment.</p>' +
                    '<p class="instructions"><i>Do <b>NOT</b> click the button below until you have submitted the above code.</i></p>';

                    return output;
                },
                choices: ['I have submitted the code. Exit the experiment.'],
                timing_post_trial: 0,
                   on_finish: function(data)
                   {
                       jsPsych.data.get().addToLast({points_exp: points_exp});
                   },
            };
        }

        //-------- Functionality --------

        // Function to draw parameters from the URL
        function $_GET(param)
        {
            var vars = {};
            window.location.href.replace(
                /[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
                function( m, key, value ) { // callback
                    vars[key] = value !== undefined ? value : '';
                }
                );

            if ( param )
            {
                console.log(vars);
                console.log(param);
                return vars[param] ? vars[param] : null;
            }
            return vars;
        }

        // Function to check compare the inputted ID to all IDs of the IDType in the SQL database
        function checkID(async, ID, IDType, data_table, callback)
        {
            $.ajax({
                type:'post',
                cache: false,
                async: async,
                url: 'checkSubID.php',
                data: // Inputs into the .php script
                {
                    ID: ID,
                    IDType: IDType,
                    completeTrials: 3450,
                    data_table: data_table
                },
                success: function(exists)  // Use whatever callback function is specified when calling the checkID function
                {
                    callback(exists);
                },
                error: function (xhr, ajaxOptions, thrownError)
                {
                   alert(thrownError);
               }
           });
        }

        // Callback function for checking if the completionCode exists
        function getNewSubID(exists)
        {
            if (exists === '1' || exists === 1) // If the completionCode exists in the SQL database
            {
                completionCode = Math.floor(Math.random() * 9000000 + 1000000); // Generate new completionCode
                checkID(false, completionCode, 'completion_code', tableName, function(existsNow){getNewSubID(existsNow);}); // Check if the new completionCode exists in the database
            }
            else // If the completionCode doesn't exist in the SQL database
                jsPsych.data.addProperties({completion_code: completionCode}); // Add the completionCode to the data
        }

        //A function to save the data to the SQL table on the server.  This gets called at the end of the file.
        function save_data(data_table,data){

            //Add data to the jsPsych data file
            jsPsych.data.addProperties({
                workerId: workerId,
                assignmentId: assignmentId,
                hitId: hitId
            });

            //Use AJAX to post the data onto the server
            $.ajax({
                type:'post',
                cache: false,
                url: 'savedata.php',
                data: {
                    table: data_table,
                    json: JSON.stringify(data),
                },
                success: function(output) { console.log(output); } // write the result to javascript console
            });
        }

        // sample function that might be used to check if a subject has given
        // consent to participate.
        function check_consent(elem) {
          if ($('#consent_checkbox').is(':checked')) {
            return true;
        }
        else {
            alert("If you wish to participate, you must check the box next to the statement 'I agree to participate in this study.'");
            return false;
        }
        return false;
    };


</script>
</html>
